name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-services:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service: [auth-service, product-service, cart-service, order-service, payment-service, inventory-service, notification-service]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with: 
          fetch-depth: 0
      - name: Remove nested .git folders (if any)
        run: |
          find . -name ".git" -type d -not -path "./.git" -exec rm -rf {} +

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Run tests for ${{ matrix.service }}
        working-directory: ${{ matrix.service }}
        run: |
          if [ -f package.json ]; then
            npm install
            if npm run | grep -q "test"; then
              npm test
            else
              echo "No test script for ${{ matrix.service }}. Skipping."
            fi
          else
            echo "No package.json in ${{ matrix.service }}. Skipping."
          fi
